{"script":"-- key limit intervalMS nowMS [amount]\nlocal key        = KEYS[1]\nlocal limit      = tonumber(ARGV[1])\nlocal intervalMS = tonumber(ARGV[2])\nlocal nowMS      = tonumber(ARGV[3])\n-- default the amount to 1 unless they specified one\nlocal amount = 1\nif ARGV[4] then\n    amount = math.max(tonumber(ARGV[4]), 0)\nend\n\nlocal ts_key = key .. \":T\";\n\nlocal tokens       = redis.call('GET',key);\nlocal lastUpdateMS = redis.call('GET',ts_key);\n\nif tokens == false then tokens = limit end;\nif lastUpdateMS == false then lastUpdateMS = nowMS end;\n\nlocal addTokens = math.floor(((nowMS - lastUpdateMS) / intervalMS) * limit);\n\nlocal newTokens = tokens + addTokens;\n\nif newTokens > limit then newTokens = limit end;\n\nnewTokens = newTokens - amount;\n\nif newTokens >= 0 then\n  -- valid request\n  redis.call('SET',ts_key,nowMS);\n  if newTokens ~= tokens then redis.call('SET',key,newTokens) end;\n  redis.call('PEXPIRE',key,intervalMS);\n  redis.call('PEXPIRE',ts_key,intervalMS);\n  return newTokens;\nelse\n  -- invalid request\n  return -1;\nend\n","sha1":"7ccb359a4182cd59227918b724d7e9c979aa1111"}